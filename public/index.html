<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Keyword Opportunity Finder</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif; background: #000; min-height: 100vh; color: #fff; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 1px solid #333; }
        .header h1 { font-size: 2.2em; display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 10px; }
        .logo { width: 80px; height: 32px; background-image: url('./sage-logo.svg'); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .header p { font-size: 1.1em; color: #a0a0a0; text-align: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 500; font-size: 0.9em; }
        input, select, button { padding: 12px; border: 2px solid #333; border-radius: 8px; font-size: 1em; background: #1a1a1a; color: #fff; }
        button { background: #00FF70; color: #000; font-weight: 600; cursor: pointer; padding: 14px 32px; font-size: 0.95em; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .dashboard { display: none; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background: #1a1a1a; border-radius: 15px; padding: 25px; border: 1px solid #333; }
        .card h3 { color: #00FF70; margin-bottom: 15px; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; }
        .metric:last-child { border-bottom: none; }
        .metric-value { font-weight: 600; color: #00FF70; font-size: 1.2em; }
        .metric-with-tooltip { display: flex; align-items: center; gap: 5px; position: relative; }
        .tooltip-trigger { color: #00FF70; cursor: help; font-size: 0.9em; }
        .tooltip { visibility: hidden; opacity: 0; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 0.85em; white-space: nowrap; z-index: 10; transition: opacity 0.2s; pointer-events: none; }
        .metric-with-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        .opportunities { display: none; background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 25px; border: 1px solid #333; }
        .opportunities h3 { color: #00FF70; margin-bottom: 20px; font-size: 1.4em; }
        .opportunity-item { background: #1a1a1a; border-radius: 10px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; }
        .opportunity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .keyword-with-intent { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .keyword { font-size: 1.1em; font-weight: 600; }
        .intent-badge, .cluster-badge, .strategy-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
        .intent-transactional { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
        .intent-comparison, .intent-commercial, .strategy-both { background: rgba(99, 162, 255, 0.2); color: #63a2ff; border: 1px solid #63a2ff; }
        .intent-informational, .strategy-organic { background: rgba(0, 255, 112, 0.2); color: #00FF70; border: 1px solid #00FF70; }
        .intent-navigational { background: rgba(150, 150, 150, 0.2); color: #969696; border: 1px solid #969696; }
        .strategy-paid_first { background: rgba(255, 193, 7, 0.2); color: #ffc107; border: 1px solid #ffc107; }
        .opportunity-score { background: #00FF70; color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 600; }
        .strategic-context { background: rgba(0, 255, 112, 0.05); border: 1px solid #00FF70; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 0.9em; line-height: 1.5; color: #ccc; }
        .strategic-context strong { color: #00FF70; }
        .opportunity-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .detail-item { text-align: center; background: #333; padding: 10px; border-radius: 8px; }
        .detail-label { font-size: 0.8em; color: #999; }
        .detail-value { font-weight: 600; }
        .status { text-align: center; padding: 20px; margin: 20px 0; border-radius: 10px; font-weight: 600; border: 1px solid; }
        .status.info { background: rgba(0, 255, 112, 0.1); color: #00FF70; border-color: #00FF70; }
        .status.error { background: rgba(255, 99, 99, 0.1); color: #ff6363; border-color: #ff6363; }
        select option { background: #1a1a1a; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><div class="logo"></div>Keyword Opportunity Finder</h1>
            <p>AI-Powered Competitive Intelligence for Organic Growth</p>
            <div class="controls">
                <div class="control-group"><label for="competitor">Competitor</label><select id="competitor"><option value="">Select Competitor</option><option value="quickbooks.intuit.com">Intuit Quickbooks</option><option value="xero.com">Xero</option><option value="netsuite.com">NetSuite</option></select></div>
                <div class="control-group"><label for="country">Market</label><select id="country"><option value="us">üá∫üá∏ United States</option><option value="gb">üá¨üáß United Kingdom</option></select></div>
                <div class="control-group"><label for="minVolume">Min Search Volume</label><input type="number" id="minVolume" value="500"></div>
                <div class="control-group"><label for="keywordLimit">Keywords to Analyze</label><input type="number" id="keywordLimit" value="100"></div>
                <div class="control-group"><label for="resultsLimit">Results to Check</label><input type="number" id="resultsLimit" value="15"></div>
                <div class="control-group"><label for="enableAI">Analysis Mode</label><select id="enableAI"><option value="false">Pattern Matching</option><option value="true">ü§ñ AI-Powered</option></select></div>
                <div class="control-group"><label>&nbsp;</label><button id="analyzeBtn">üîç Find Opportunities</button></div>
            </div>
        </div>
        <div id="status" class="status info">Ready to analyze keyword opportunities.</div>
        <div class="dashboard" id="dashboard" style="display:none;">
            <div class="card">
                <h3>üìä Analysis Overview</h3>
                <div class="metric"><div class="metric-with-tooltip"><span>Total Keywords Analyzed</span><div class="tooltip">Initial # of keywords from Ahrefs</div></div><span class="metric-value" id="totalKeywords">0</span></div>
                <div class="metric"><div class="metric-with-tooltip"><span>Opportunity Keywords Found</span><div class="tooltip"># of keywords meeting our criteria</div></div><span class="metric-value" id="opportunityKeywords">0</span></div>
                <div class="metric"><div class="metric-with-tooltip"><span>Potential Monthly Traffic</span><div class="tooltip">Total est. organic clicks/mo</div></div><span class="metric-value" id="potentialTraffic">0</span></div>
                <div class="metric"><div class="metric-with-tooltip"><span>Est. Revenue Opportunity</span><div class="tooltip">Total est. revenue/mo</div></div><span class="metric-value" id="revenueOpportunity">$0</span></div>
            </div>
            <div class="card">
                <h3>üéØ Opportunity Breakdown</h3>
                <div class="metric"><span>High Priority (Score > 80)</span><span class="metric-value" id="highPriority">0</span></div>
                <div class="metric"><span>Medium Priority (60-79)</span><span class="metric-value" id="mediumPriority">0</span></div>
                <div class="metric"><span>Low Priority (< 60)</span><span class="metric-value" id="lowPriority">0</span></div>
                <div class="metric"><div class="metric-with-tooltip"><span>Avg. Keyword Difficulty</span><div class="tooltip">Avg. Ahrefs KD score</div></div><span class="metric-value" id="avgDifficulty">0</span></div>
            </div>
        </div>
        <div class="opportunities" id="opportunities" style="display:none;">
            <h3>üèÜ Top Keyword Opportunities</h3>
            <div id="opportunityList"></div>
        </div>
    </div>

    <script>
        const analyzeBtn = document.getElementById('analyzeBtn');
        const statusDiv = document.getElementById('status');
        const opportunityList = document.getElementById('opportunityList');
        const opportunitiesDiv = document.getElementById('opportunities');
        const dashboardDiv = document.getElementById('dashboard');

        analyzeBtn.addEventListener('click', async () => {
            const payload = { competitor: document.getElementById('competitor').value, country: document.getElementById('country').value, minVolume: document.getElementById('minVolume').value, keywordLimit: document.getElementById('keywordLimit').value, resultsLimit: document.getElementById('resultsLimit').value, enableAI: document.getElementById('enableAI').value, };
            if (!payload.competitor) { showStatus('Please select a competitor.', 'error'); return; }
            analyzeBtn.disabled = true;
            showStatus('Submitting analysis job...', 'info');
            opportunitiesDiv.style.display = 'none';
            dashboardDiv.style.display = 'none';
            opportunityList.innerHTML = '';
            try {
                const response = await fetch('/api/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (response.status !== 202) { const errorData = await response.json().catch(() => ({ error: `Server error ${response.status}` })); throw new Error(errorData.error); }
                const { jobId } = await response.json();
                await pollForResults(jobId);
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                analyzeBtn.disabled = false;
            }
        });

        async function pollForResults(jobId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/status/${jobId}`);
                    if (!response.ok) { clearInterval(interval); throw new Error(`Status check failed`); }
                    const job = await response.json();
                    if (job.status === 'pending' || job.status === 'processing') {
                        showStatus(job.progress || 'Processing...', 'info');
                    } else if (job.status === 'complete') {
                        clearInterval(interval);
                        showStatus(`‚úÖ Analysis Complete! Found ${job.data.opportunities.length} relevant opportunities.`, 'info');
                        displayResults(job.data);
                        analyzeBtn.disabled = false;
                    } else if (job.status === 'error') {
                        clearInterval(interval);
                        throw new Error(job.error);
                    }
                } catch (error) {
                    clearInterval(interval);
                    showStatus(`Error: ${error.message}`, 'error');
                    analyzeBtn.disabled = false;
                }
            }, 3000);
        }

        function showStatus(message, type) { statusDiv.className = `status ${type}`; statusDiv.textContent = message; }
        
        function displayResults(data) {
            updateDashboard(data);
            updateOpportunities(data.opportunities);
            dashboardDiv.style.display = 'grid';
            opportunitiesDiv.style.display = 'block';
        }

        function getIntentBadgeClass(intent) {
            const lowerIntent = intent?.toLowerCase();
            if (lowerIntent === 'transactional') return 'intent-transactional';
            if (lowerIntent === 'informational') return 'intent-informational';
            if (lowerIntent === 'navigational') return 'intent-navigational';
            if (lowerIntent === 'comparison') return 'intent-comparison';
            return 'intent-commercial';
        }

        function getPaidStrategyClass(strategy = '') {
            const lowerStrategy = strategy.toLowerCase().replace(/ /g, '_');
            return `strategy-${lowerStrategy}`;
        }
        
        function updateDashboard(data) {
            const { opportunities = [], aiAnalysis = {}, totalKeywords = 0 } = data;
            document.getElementById('totalKeywords').textContent = (totalKeywords).toLocaleString();
            document.getElementById('opportunityKeywords').textContent = opportunities.length;
            const potentialTraffic = opportunities.reduce((sum, opp) => sum + (opp.estimatedTraffic || 0), 0);
            document.getElementById('potentialTraffic').textContent = potentialTraffic.toLocaleString();
            const revenueOpportunity = opportunities.reduce((sum, opp) => sum + (opp.monthlyRevenue || 0), 0);
            document.getElementById('revenueOpportunity').textContent = `$${revenueOpportunity.toLocaleString()}`;
            document.getElementById('highPriority').textContent = opportunities.filter(opp => opp.score >= 80).length;
            document.getElementById('mediumPriority').textContent = opportunities.filter(opp => opp.score >= 60 && opp.score < 80).length;
            document.getElementById('lowPriority').textContent = opportunities.filter(opp => opp.score < 60).length;
            const avgDifficulty = opportunities.length ? Math.round(opportunities.reduce((sum, opp) => sum + (opp.difficulty || 0), 0) / opportunities.length) : 0;
            document.getElementById('avgDifficulty').textContent = avgDifficulty;
        }

        function updateOpportunities(opportunities = []) {
            opportunityList.innerHTML = '';
            if (opportunities.length === 0) {
                opportunitiesDiv.style.display = 'block';
                opportunityList.innerHTML = '<div class="opportunity-item"><p>No high-value opportunities found. Try expanding the limits or changing the competitor.</p></div>';
                return;
            }
            opportunities.forEach(opp => {
                const item = document.createElement('div');
                item.className = 'opportunity-item';
                const { aiInsights = {} } = opp;
                const { paidInsights = {}, revenueModel = {} } = aiInsights;
                const strategicContextHTML = aiInsights.aiPowered && aiInsights.strategicContext ? `<div class="strategic-context"><strong>Strategic Angle:</strong> ${aiInsights.strategicContext}</div>` : '';
                const intent = aiInsights.intent || aiInsights.commercialIntent || 'N/A';
                const category = aiInsights.category ? `<span class="cluster-badge">${aiInsights.category}</span>` : `<span class="cluster-badge">${(aiInsights.contentCluster || 'general').replace(/_/g, ' ')}</span>`;
                const paidStrategy = paidInsights.paidStrategy || 'Organic';

                item.innerHTML = `
                    <div class="opportunity-header">
                        <div class="keyword-with-intent">
                            <span class="keyword">${opp.keyword}</span>
                            <span class="intent-badge ${getIntentBadgeClass(intent)}">${intent}</span>
                            ${category}
                        </div>
                        <span class="opportunity-score">Score: ${opp.score}</span>
                    </div>
                    ${strategicContextHTML}
                    <div class="opportunity-details">
                        <div class="detail-item">
                            <div class="detail-label">Search Volume</div>
                            <div class="detail-value">${(opp.searchVolume || 0).toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>Difficulty</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Ahrefs KD Score</div>
                                </div>
                            </div>
                            <div class="detail-value">${opp.difficulty || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Competitor Rank</div>
                            <div class="detail-value">#${opp.competitorPosition || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Sage Rank</div>
                            <div class="detail-value">${opp.sagePosition ? `#${opp.sagePosition}` : 'Not ranking'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>Est. Org. Traffic</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Calculated using keyword volume and a Click-Through Rate (CTR) based on user intent.</div>
                                </div>
                            </div>
                            <div class="detail-value">${(opp.estimatedTraffic || 0).toLocaleString()}/mo</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>Est. Org. Revenue</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Based on estimated traffic, intent-based conversion rates, and a predefined $30,000 customer value.</div>
                                </div>
                            </div>
                            <div class="detail-value">$${(opp.monthlyRevenue || 0).toLocaleString()}/mo</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>CPC</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Ahrefs Cost Per Click</div>
                                </div>
                            </div>
                            <div class="detail-value">$${(opp.cpc || 0).toFixed(2)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>Est. Paid Clicks</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Based on keyword volume and a Click-Through Rate (CTR) model adjusted for user intent and CPC competition.</div>
                                </div>
                            </div>
                            <div class="detail-value">${(paidInsights.estimatedPaidClicks || 0).toLocaleString()}/mo</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">
                                <div class="metric-with-tooltip">
                                    <span>Paid Strategy</span>
                                    <span class="tooltip-trigger">‚ÑπÔ∏è</span>
                                    <div class="tooltip">Recommendation based on a combination of keyword difficulty, CPC, and user intent.</div>
                                </div>
                            </div>
                            <div class="detail-value"><span class="strategy-badge ${getPaidStrategyClass(paidInsights.paidStrategy)}">${paidStrategy.replace(/_/g, ' ')}</span></div>
                        </div>
                    </div>
                `;
                opportunityList.appendChild(item);
            });
        }
    </script>
</body>
</html>